{"version":3,"sources":["../../src/middlewares/auth.js"],"names":["config","require","UserModel","authUser","req","res","next","locals","currentUser","session","user","authToken","signedCookies","cookieName","findOne","_id","err","toObject","isAdmin","loginname","admin","adminRequired","Error","status","module","exports"],"mappings":";;AAAA,IAAIA,SAASC,QAAQ,WAAR,CAAb;AACA,IAAIC,YAAYD,QAAQ,gBAAR,CAAhB;;AAEA,SAASE,QAAT,CAAkBC,GAAlB,EAAuBC,GAAvB,EAA4BC,IAA5B,EAAkC;AAChCD,MAAIE,MAAJ,CAAWC,WAAX,GAAyB,IAAzB;;AAEA,MAAIJ,IAAIK,OAAJ,IAAeL,IAAIK,OAAJ,CAAYC,IAA/B,EAAqC;AACnC,QAAMA,OAAON,IAAIK,OAAJ,CAAYC,IAAzB;AACAL,QAAIE,MAAJ,CAAWC,WAAX,GAAyBE,IAAzB;AACAJ;AACD,GAJD,MAIO;AACL,QAAMK,YAAYP,IAAIQ,aAAJ,CAAkBZ,OAAOa,UAAzB,KAAwC,EAA1D;;AAEA,QAAIF,SAAJ,EAAe;AACbT,gBAAUY,OAAV,CAAkB,EAAEC,KAAKJ,SAAP,EAAlB,EAAsC,UAASK,GAAT,EAAcN,IAAd,EAAoB;AACxD,YAAIM,GAAJ,EAAS;AACPV;AACD,SAFD,MAEO;AACLI,iBAAOA,KAAKO,QAAL,EAAP;AACAP,eAAKQ,OAAL,GAAeR,KAAKS,SAAL,KAAmBnB,OAAOoB,KAAzC;;AAEAhB,cAAIK,OAAJ,CAAYC,IAAZ,GAAmBA,IAAnB;AACAL,cAAIE,MAAJ,CAAWC,WAAX,GAAyBE,IAAzB;AACAJ;AACD;AACF,OAXD;AAYD,KAbD,MAaO;AACLA;AACD;AACF;AACF;;AAED,SAASe,aAAT,CAAuBjB,GAAvB,EAA4BC,GAA5B,EAAiCC,IAAjC,EAAuC;AACrC,MAAI,CAACF,IAAIK,OAAL,IAAgB,CAACL,IAAIK,OAAJ,CAAYC,IAAjC,EAAuC;AACrC,QAAIM,MAAM,IAAIM,KAAJ,CAAU,MAAV,CAAV;AACAN,QAAIO,MAAJ,GAAa,GAAb;AACAjB,SAAKU,GAAL;AACA;AACD;;AAED,MAAI,CAACZ,IAAIK,OAAJ,CAAYC,IAAZ,CAAiBQ,OAAtB,EAA+B;AAC7B,QAAIF,OAAM,IAAIM,KAAJ,CAAU,SAAV,CAAV;AACAN,SAAIO,MAAJ,GAAa,GAAb;AACAjB,SAAKU,IAAL;AACA;AACD;;AAEDV;AACD;;AAEDkB,OAAOC,OAAP,GAAiB,EAAEtB,kBAAF,EAAYkB,4BAAZ,EAAjB","file":"auth.js","sourcesContent":["var config = require('../config');\nvar UserModel = require('../models/user');\n\nfunction authUser(req, res, next) {\n  res.locals.currentUser = null;\n\n  if (req.session && req.session.user) {\n    const user = req.session.user;\n    res.locals.currentUser = user;\n    next();\n  } else {\n    const authToken = req.signedCookies[config.cookieName] || '';\n\n    if (authToken) {\n      UserModel.findOne({ _id: authToken }, function(err, user) {\n        if (err) {\n          next();\n        } else {\n          user = user.toObject();\n          user.isAdmin = user.loginname === config.admin;\n\n          req.session.user = user;\n          res.locals.currentUser = user;\n          next();\n        }\n      });\n    } else {\n      next();\n    }\n  }\n}\n\nfunction adminRequired(req, res, next) {\n  if (!req.session || !req.session.user) {\n    let err = new Error('需要登录');\n    err.status = 403;\n    next(err);\n    return;\n  }\n\n  if (!req.session.user.isAdmin) {\n    let err = new Error('需要管理员权限');\n    err.status = 403;\n    next(err);\n    return;\n  }\n\n  next();\n}\n\nmodule.exports = { authUser, adminRequired };\n"]}